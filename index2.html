<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadan Dashboard</title>
    <meta name="author" content="Yasin Ullah">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;600&display=swap');

        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #FF9800; /* Orange */
            --background-color: #F3E5F5; /* Light Purple */
            --card-background: #FFFFFF;
            --text-color: #333;
            --header-background: #673AB7; /* Deep Purple */
            --header-text: #FFFFFF;
            --border-color: #E0E0E0;
            --progress-bar-fill: #8BC34A; /* Light Green */
            --progress-bar-background: #E0E0E0;
            --button-background: var(--primary-color);
            --button-text: white;
            --danger-color: #F44336; /* Red */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            overflow-x: hidden;
        }

        header {
            background-color: var(--header-background);
            color: var(--header-text);
            padding: 1rem 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        header h1 {
            margin: 0;
            font-family: 'Amiri', serif;
            font-weight: 700;
            font-size: 2.5em;
        }

        .crescent-moon {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 15px 15px, transparent 20px, var(--header-text) 20px);
            border-radius: 50%;
            transform: rotate(-45deg);
        }

        .stars {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 5px;
            height: 5px;
            background-color: var(--header-text);
            border-radius: 50%;
            box-shadow: 10px 10px var(--header-text), 20px 0 var(--header-text), 30px 15px var(--header-text);
        }

        main {
            padding: 20px;
            max-width: 900px;
            margin: 20px auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .card h2 {
            margin-top: 0;
            color: var(--primary-color);
            font-family: 'Amiri', serif;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input[type="text"],
        input[type="time"],
        input[type="number"],
        textarea,
        select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
        }

        button {
            background-color: var(--button-background);
            color: var(--button-text);
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: darken(var(--button-background), 10%);
        }

        .danger-button {
            background-color: var(--danger-color);
        }

        .danger-button:hover {
            background-color: darken(var(--danger-color), 10%);
        }

        .progress-bar-container {
            width: 100%;
            background-color: var(--progress-bar-background);
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 20px;
            background-color: var(--progress-bar-fill);
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 0.9em;
            transition: width 0.5s ease;
        }

        .dua-list {
            list-style: none;
            padding: 0;
        }

        .dua-item {
            background-color: #F9F9F9;
            border: 1px solid var(--border-color);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dua-item button {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        .log-entry {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .log-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .log-entry h3 {
            margin: 0 0 5px 0;
            color: var(--secondary-color);
        }

        .log-entry p {
            margin: 0 0 5px 0;
            font-size: 0.9em;
        }

        .countdown {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        #backupRestoreSection {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        #backupRestoreSection h2 {
            color: var(--header-background);
        }

        #backupRestoreSection button {
            margin-right: 10px;
        }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            color: var(--text-color);
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            main {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="crescent-moon"></div>
        <div class="stars"></div>
        <h1>Ramadan Dashboard</h1>
    </header>

    <main>
        <section class="card">
            <h2>Daily Log</h2>
            <div class="countdown" id="countdown">Loading countdown...</div>
            <label for="logDate">Date:</label>
            <input type="date" id="logDate" value="">

            <label for="fastingStatus">Fasting Status:</label>
            <select id="fastingStatus">
                <option value="fasted">Fasted</option>
                <option value="not-fasted">Not Fasted</option>
            </select>

            <label for="suhoorTime">Suhoor Time:</label>
            <input type="time" id="suhoorTime">

            <label for="iftarTime">Iftar Time:</label>
            <input type="time" id="iftarTime">

            <label for="quranProgress">Quran Reading Progress (Juz/Pages):</label>
            <input type="text" id="quranProgress" placeholder="e.g., Juz 5, Page 100">

            <label for="taraweehPrayers">Taraweeh Prayers:</label>
            <select id="taraweehPrayers">
                <option value="completed">Completed</option>
                <option value="missed">Missed</option>
                <option value="partially">Partially</option>
            </select>

            <label for="charitableActs">Charitable Acts:</label>
            <textarea id="charitableActs" rows="3" placeholder="Describe your charitable acts today"></textarea>

            <label for="moodReflections">Mood/Reflections:</label>
            <textarea id="moodReflections" rows="3" placeholder="How was your day? Any reflections?"></textarea>

            <button onclick="saveDailyLog()">Save Daily Log</button>

            <div id="dailyLogsList" style="margin-top: 20px;">
                <h3>Previous Logs</h3>
                <div id="logsContainer"></div>
            </div>
        </section>

        <section class="card">
            <h2>Ramadan Goals</h2>
            <label for="goalDescription">Goal Description:</label>
            <input type="text" id="goalDescription" placeholder="e.g., Complete Quran, Donate $100">

            <label for="goalTarget">Target:</label>
            <input type="text" id="goalTarget" placeholder="e.g., 30 Juz, $100">

            <button onclick="addGoal()">Add Goal</button>

            <div id="goalsList" style="margin-top: 20px;">
                <h3>Your Goals</h3>
                <div id="goalsContainer"></div>
            </div>
        </section>

        <section class="card">
            <h2>Duas & Adhkar</h2>
            <label for="duaText">Dua/Adhkar Text:</label>
            <textarea id="duaText" rows="3" placeholder="Enter the Dua or Adhkar"></textarea>

            <label for="duaReference">Reference (Optional):</label>
            <input type="text" id="duaReference" placeholder="e.g., Sahih Bukhari, Hadith #">

            <button onclick="addDua()">Add Dua</button>

            <div id="duasList" style="margin-top: 20px;">
                <h3>Your Collection</h3>
                <ul class="dua-list" id="duaCollection"></ul>
            </div>
        </section>

        <section class="card">
            <h2>Progress Visualization</h2>
            <p>Track your progress towards your goals here.</p>
            <div id="progressVisualization">
                <!-- Progress bars will be rendered here -->
            </div>
        </section>

        <section class="card">
            <h2>Post-Ramadan Reflection</h2>
            <p>Reflect on your Ramadan journey after it ends.</p>
            <textarea id="postRamadanReflection" rows="5" placeholder="Write your reflections here after Ramadan"></textarea>
            <button onclick="savePostRamadanReflection()">Save Reflection</button>
            <div id="savedReflection" style="margin-top: 10px;"></div>
        </section>

        <section class="card" id="backupRestoreSection">
            <h2>Backup & Restore</h2>
            <p>Backup your data or restore from a previous backup.</p>
            <button onclick="backupData()">Backup Data</button>
            <input type="file" id="restoreFile" accept=".json" style="display: none;">
            <button onclick="document.getElementById('restoreFile').click()">Restore Data</button>
            <p id="backupRestoreStatus" style="margin-top: 10px;"></p>
        </section>
    </main>

    <footer>
        Â© 2023 Ramadan Dashboard. Developed by Yasin Ullah.
    </footer>

    <script>
        const DB_NAME = 'ramadanDashboardDB';
        const DB_VERSION = 1;
        let db;

        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0!
        const dd = String(today.getDate()).padStart(2, '0');
        const todayString = `${yyyy}-${mm}-${dd}`;

        document.getElementById('logDate').value = todayString;

        // IndexedDB Setup
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = function(event) {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('dailyLogs')) {
                        db.createObjectStore('dailyLogs', { keyPath: 'date' });
                    }
                    if (!db.objectStoreNames.contains('goals')) {
                        db.createObjectStore('goals', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('duas')) {
                        db.createObjectStore('duas', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('reflections')) {
                        db.createObjectStore('reflections', { keyPath: 'id', autoIncrement: true });
                    }
                };

                request.onsuccess = function(event) {
                    db = event.target.result;
                    console.log('Database opened successfully');
                    resolve(db);
                    loadDailyLogs();
                    loadGoals();
                    loadDuas();
                    loadPostRamadanReflection();
                    updateProgressVisualization();
                    startCountdown();
                };

                request.onerror = function(event) {
                    console.error('Database error:', event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        // Daily Log Functions
        async function saveDailyLog() {
            const date = document.getElementById('logDate').value;
            const fastingStatus = document.getElementById('fastingStatus').value;
            const suhoorTime = document.getElementById('suhoorTime').value;
            const iftarTime = document.getElementById('iftarTime').value;
            const quranProgress = document.getElementById('quranProgress').value;
            const taraweehPrayers = document.getElementById('taraweehPrayers').value;
            const charitableActs = document.getElementById('charitableActs').value;
            const moodReflections = document.getElementById('moodReflections').value;

            if (!date) {
                alert('Please select a date.');
                return;
            }

            const log = {
                date: date,
                fastingStatus: fastingStatus,
                suhoorTime: suhoorTime,
                iftarTime: iftarTime,
                quranProgress: quranProgress,
                taraweehPrayers: taraweehPrayers,
                charitableActs: charitableActs,
                moodReflections: moodReflections
            };

            try {
                const transaction = db.transaction(['dailyLogs'], 'readwrite');
                const store = transaction.objectStore('dailyLogs');
                await store.put(log);

                transaction.oncomplete = function() {
                    console.log('Daily log saved successfully');
                    alert('Daily log saved!');
                    loadDailyLogs(); // Refresh the list
                    updateProgressVisualization();
                };

                transaction.onerror = function(event) {
                    console.error('Error saving daily log:', event.target.error);
                    alert('Error saving daily log.');
                };
            } catch (error) {
                console.error('IndexedDB transaction error:', error);
                alert('An error occurred while saving.');
            }
        }

        async function loadDailyLogs() {
            const logsContainer = document.getElementById('logsContainer');
            logsContainer.innerHTML = ''; // Clear previous logs

            try {
                const transaction = db.transaction(['dailyLogs'], 'readonly');
                const store = transaction.objectStore('dailyLogs');
                const request = store.openCursor(null, 'prev'); // Show latest first

                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        const log = cursor.value;
                        const logElement = document.createElement('div');
                        logElement.classList.add('log-entry');
                        logElement.innerHTML = `
                            <h3>${log.date}</h3>
                            <p><strong>Fasting:</strong> ${log.fastingStatus}</p>
                            <p><strong>Suhoor:</strong> ${log.suhoorTime || 'N/A'}</p>
                            <p><strong>Iftar:</strong> ${log.iftarTime || 'N/A'}</p>
                            <p><strong>Quran:</strong> ${log.quranProgress || 'N/A'}</p>
                            <p><strong>Taraweeh:</strong> ${log.taraweehPrayers || 'N/A'}</p>
                            <p><strong>Charity:</strong> ${log.charitableActs || 'N/A'}</p>
                            <p><strong>Reflections:</strong> ${log.moodReflections || 'N/A'}</p>
                        `;
                        logsContainer.appendChild(logElement);
                        cursor.continue();
                    }
                };

                request.onerror = function(event) {
                    console.error('Error loading daily logs:', event.target.error);
                };
            } catch (error) {
                console.error('IndexedDB transaction error:', error);
            }
        }

        // Goal Functions
        async function addGoal() {
            const description = document.getElementById('goalDescription').value.trim();
            const target = document.getElementById('goalTarget').value.trim();

            if (!description || !target) {
                alert('Please enter both goal description and target.');
                return;
            }

            const goal = {
                description: description,
                target: target,
                progress: 0 // Initial progress
            };

            try {
                const transaction = db.transaction(['goals'], 'readwrite');
                const store = transaction.objectStore('goals');
                await store.add(goal);

                transaction.oncomplete = function() {
                    console.log('Goal added successfully');
                    alert('Goal added!');
                    document.getElementById('goalDescription').value = '';
                    document.getElementById('goalTarget').value = '';
                    loadGoals(); // Refresh the list
                    updateProgressVisualization();
                };

                transaction.onerror = function(event) {
                    console.error('Error adding goal:', event.target.error);
                    alert('Error adding goal.');
                };
            } catch (error) {
                console.error('IndexedDB transaction error:', error);
                alert('An error occurred while adding the goal.');
            }
        }

        async function loadGoals() {
            const goalsContainer = document.getElementById('goalsContainer');
            goalsContainer.innerHTML = ''; // Clear previous goals

            try {
                const transaction = db.transaction(['goals'], 'readonly');
                const store = transaction.objectStore('goals');
                const request = store.openCursor();

                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        const goal = cursor.value;
                        const goalElement = document.createElement('div');
                        goalElement.innerHTML = `
                            <p><strong>${goal.description}</strong> (Target: ${goal.target})</p>
                            <button onclick="deleteGoal(${goal.id})" class="danger-button">Delete</button>
                        `;
                        goalsContainer.appendChild(goalElement);
                        cursor.continue();
                    }
                };

                request.onerror = function(event) {
                    console.error('Error loading goals:', event.target.error);
                };
            } catch (error) {
                console.error('IndexedDB transaction error:', error);
            }
        }

        async function deleteGoal(id) {
            if (!confirm('Are you sure you want to delete this goal?')) {
                return;
            }
            try {
                const transaction = db.transaction(['goals'], 'readwrite');
                const store = transaction.objectStore('goals');
                await store.delete(id);

                transaction.oncomplete = function() {
                    console.log('Goal deleted successfully');
                    loadGoals(); // Refresh the list
                    updateProgressVisualization();
                };

                transaction.onerror = function(event) {
                    console.error('Error deleting goal:', event.target.error);
                    alert('Error deleting goal.');
                };
            } catch (error) {
                console.error('IndexedDB transaction error:', error);
                alert('An error occurred while deleting the goal.');
            }
        }

        // Dua Functions
        async function addDua() {
            const text = document.getElementById('duaText').value.trim();
            const reference = document.getElementById('duaReference').value.trim();

            if (!text) {
                alert('Please enter the Dua or Adhkar text.');
                return;
            }

            const dua = {
                text: text,
                reference: reference
            };

            try {
                const transaction = db.transaction(['duas'], 'readwrite');
                const store = transaction.objectStore('duas');
                await store.add(dua);

                transaction.oncomplete = function() {
                    console.log('Dua added successfully');
                    alert('Dua added!');
                    document.getElementById('duaText').value = '';
                    document.getElementById('duaReference').value = '';
                    loadDuas(); // Refresh the list
                };

                transaction.onerror = function(event) {
                    console.error('Error adding dua:', event.target.error);
                    alert('Error adding dua.');
                };
            } catch (error) {
                console.error('IndexedDB transaction error:', error);
                alert('An error occurred while adding the dua.');
            }
        }

        async function loadDuas() {
            const duaCollection = document.getElementById('duaCollection');
            duaCollection.innerHTML = ''; // Clear previous duas

            try {
                const transaction = db.transaction(['duas'], 'readonly');
                const store = transaction.objectStore('duas');
                const request = store.openCursor();

                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        const dua = cursor.value;
                        const duaElement = document.createElement('li');
                        duaElement.classList.add('dua-item');
                        duaElement.innerHTML = `
                            <div>
                                <p>${dua.text}</p>
                                ${dua.reference ? `<p><em>Reference: ${dua.reference}</em></p>` : ''}
                            </div>
                            <button onclick="deleteDua(${dua.id})" class="danger-button">Delete</button>
                        `;
                        duaCollection.appendChild(duaElement);
                        cursor.continue();
                    }
                };

                request.onerror = function(event) {
                    console.error('Error loading duas:', event.target.error);
                };
            } catch (error) {
                console.error('IndexedDB transaction error:', error);
            }
        }

        async function deleteDua(id) {
            if (!confirm('Are you sure you want to delete this Dua?')) {
                return;
            }
            try {
                const transaction = db.transaction(['duas'], 'readwrite');
                const store = transaction.objectStore('duas');
                await store.delete(id);

                transaction.oncomplete = function() {
                    console.log('Dua deleted successfully');
                    loadDuas(); // Refresh the list
                };

                transaction.onerror = function(event) {
                    console.error('Error deleting dua:', event.target.error);
                    alert('Error deleting dua.');
                };
            } catch (error) {
                console.error('IndexedDB transaction error:', error);
                alert('An error occurred while deleting the dua.');
            }
        }

        // Progress Visualization
        async function updateProgressVisualization() {
            const progressVisualizationDiv = document.getElementById('progressVisualization');
            progressVisualizationDiv.innerHTML = ''; // Clear previous visualization

            try {
                const transaction = db.transaction(['goals', 'dailyLogs'], 'readonly');
                const goalsStore = transaction.objectStore('goals');
                const logsStore = transaction.objectStore('dailyLogs');

                const goalsRequest = goalsStore.getAll();
                const logsRequest = logsStore.getAll();

                goalsRequest.onsuccess = function(event) {
                    const goals = event.target.result;

                    logsRequest.onsuccess = function(event) {
                        const logs = event.target.result;

                        goals.forEach(goal => {
                            let currentProgress = 0;
                            let totalTarget = 0;

                            // Simple logic to calculate progress based on goal description
                            if (goal.description.toLowerCase().includes('quran')) {
                                // Count days with Quran progress logged
                                currentProgress = logs.filter(log => log.quranProgress && log.quranProgress.trim() !== '').length;
                                // Assuming a target of 30 days for Quran completion
                                totalTarget = 30;
                            } else if (goal.description.toLowerCase().includes('charity')) {
                                // Count days with charitable acts logged
                                currentProgress = logs.filter(log => log.charitableActs && log.charitableActs.trim() !== '').length;
                                // Assuming a target of 30 days for daily charity
                                totalTarget = 30;
                                // More advanced: try to parse numbers from target and logs
                                try {
                                    const targetAmount = parseFloat(goal.target.replace(/[^0-9.]/g, ''));
                                    if (!isNaN(targetAmount)) {
                                        totalTarget = targetAmount;
                                        currentProgress = logs.reduce((sum, log) => {
                                            if (log.charitableActs) {
                                                const numbersInLog = log.charitableActs.match(/\d+(\.\d+)?/g);
                                                if (numbersInLog) {
                                                    sum += numbersInLog.reduce((logSum, num) => logSum + parseFloat(num), 0);
                                                }
                                            }
                                            return sum;
                                        }, 0);
                                    }
                                } catch (e) {
                                    console.warn("Could not parse charity target/progress as number:", e);
                                }
                            } else if (goal.description.toLowerCase().includes('fasting')) {
                                // Count days fasted
                                currentProgress = logs.filter(log => log.fastingStatus === 'fasted').length;
                                // Assuming a target of 30 days
                                totalTarget = 30;
                            }
                            // Add more goal types and progress calculation logic here

                            const percentage = totalTarget > 0 ? Math.min(100, (currentProgress / totalTarget) * 100) : 0;

                            const progressElement = document.createElement('div');
                            progressElement.innerHTML = `
                                <p>${goal.description}: ${currentProgress} / ${totalTarget}</p>
                                <div class="progress-bar-container">
                                    <div class="progress-bar" style="width: ${percentage}%;">
                                        ${Math.round(percentage)}%
                                    </div>
                                </div>
                            `;
                            progressVisualizationDiv.appendChild(progressElement);
                        });
                    };

                    logsRequest.onerror = function(event) {
                        console.error('Error fetching logs for progress:', event.target.error);
                    };
                };

                goalsRequest.onerror = function(event) {
                    console.error('Error fetching goals for progress:', event.target.error);
                };

            } catch (error) {
                console.error('IndexedDB transaction error for progress:', error);
            }
        }


        // Post-Ramadan Reflection
        async function savePostRamadanReflection() {
            const reflectionText = document.getElementById('postRamadanReflection').value.trim();

            if (!reflectionText) {
                alert('Please write your reflection before saving.');
                return;
            }

            const reflection = {
                id: 1, // Only one reflection entry
                text: reflectionText,
                timestamp: new Date().toISOString()
            };

            try {
                const transaction = db.transaction(['reflections'], 'readwrite');
                const store = transaction.objectStore('reflections');
                await store.put(reflection); // Use put to overwrite if exists

                transaction.oncomplete = function() {
                    console.log('Post-Ramadan reflection saved successfully');
                    alert('Reflection saved!');
                    loadPostRamadanReflection();
                };

                transaction.onerror = function(event) {
                    console.error('Error saving reflection:', event.target.error);
                    alert('Error saving reflection.');
                };
            } catch (error) {
                console.error('IndexedDB transaction error:', error);
                alert('An error occurred while saving the reflection.');
            }
        }

        async function loadPostRamadanReflection() {
            const savedReflectionDiv = document.getElementById('savedReflection');
            savedReflectionDiv.innerHTML = '';

            try {
                const transaction = db.transaction(['reflections'], 'readonly');
                const store = transaction.objectStore('reflections');
                const request = store.get(1); // Get the single reflection entry

                request.onsuccess = function(event) {
                    const reflection = event.target.result;
                    if (reflection) {
                        savedReflectionDiv.innerHTML = `
                            <h3>Saved Reflection:</h3>
                            <p>${reflection.text}</p>
                            <p><em>Saved on: ${new Date(reflection.timestamp).toLocaleString()}</em></p>
                        `;
                        document.getElementById('postRamadanReflection').value = reflection.text; // Load into textarea
                    }
                };

                request.onerror = function(event) {
                    console.error('Error loading reflection:', event.target.error);
                };
            } catch (error) {
                console.error('IndexedDB transaction error:', error);
            }
        }

        // Countdown Timer (Basic - needs actual Ramadan dates)
        function startCountdown() {
            // This is a placeholder. You would need to set the actual Iftar/Suhoor times
            // based on user input or an external source (like My Prayer Times app data).
            // For demonstration, let's assume Iftar is at 7:00 PM today.
            const now = new Date();
            const iftarTimeToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 19, 0, 0); // 7:00 PM

            // If Iftar has passed today, set countdown to tomorrow's Iftar
            if (now > iftarTimeToday) {
                 iftarTimeToday.setDate(iftarTimeToday.getDate() + 1);
            }

            const countdownElement = document.getElementById('countdown');

            function updateCountdown() {
                const currentTime = new Date().getTime();
                const distance = iftarTimeToday.getTime() - currentTime;

                if (distance < 0) {
                    countdownElement.innerHTML = "Iftar Time!";
                    // You might want to switch to Suhoor countdown here
                    return;
                }

                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownElement.innerHTML = `Iftar Countdown: ${hours}h ${minutes}m ${seconds}s`;
            }

            // Update the countdown every second
            setInterval(updateCountdown, 1000);
            updateCountdown(); // Initial call
        }

        // Backup and Restore
        async function backupData() {
            const statusElement = document.getElementById('backupRestoreStatus');
            statusElement.textContent = 'Preparing backup...';

            try {
                const transaction = db.transaction(['dailyLogs', 'goals', 'duas', 'reflections'], 'readonly');
                const dailyLogsStore = transaction.objectStore('dailyLogs');
                const goalsStore = transaction.objectStore('goals');
                const duasStore = transaction.objectStore('duas');
                const reflectionsStore = transaction.objectStore('reflections');

                const dailyLogsRequest = dailyLogsStore.getAll();
                const goalsRequest = goalsStore.getAll();
                const duasRequest = duasStore.getAll();
                const reflectionsRequest = reflectionsStore.getAll();

                const backupData = {};

                dailyLogsRequest.onsuccess = function(event) {
                    backupData.dailyLogs = event.target.result;
                    goalsRequest.onsuccess = function(event) {
                        backupData.goals = event.target.result;
                        duasRequest.onsuccess = function(event) {
                            backupData.duas = event.target.result;
                            reflectionsRequest.onsuccess = function(event) {
                                backupData.reflections = event.target.result;

                                const dataStr = JSON.stringify(backupData, null, 2);
                                const blob = new Blob([dataStr], { type: 'application/json' });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `ramadan_dashboard_backup_${todayString}.json`;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);

                                statusElement.textContent = 'Backup created successfully.';
                            };
                            reflectionsRequest.onerror = (e) => { console.error('Error fetching reflections for backup:', e); statusElement.textContent = 'Error during backup.'; };
                        };
                        duasRequest.onerror = (e) => { console.error('Error fetching duas for backup:', e); statusElement.textContent = 'Error during backup.'; };
                    };
                    goalsRequest.onerror = (e) => { console.error('Error fetching goals for backup:', e); statusElement.textContent = 'Error during backup.'; };
                };
                dailyLogsRequest.onerror = (e) => { console.error('Error fetching daily logs for backup:', e); statusElement.textContent = 'Error during backup.'; };

            } catch (error) {
                console.error('IndexedDB transaction error during backup:', error);
                statusElement.textContent = 'An error occurred during backup.';
            }
        }

        async function restoreData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const statusElement = document.getElementById('backupRestoreStatus');
            statusElement.textContent = 'Restoring data...';

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);

                    if (!confirm('Restoring will overwrite your current data. Are you sure?')) {
                        statusElement.textContent = 'Restore cancelled.';
                        return;
                    }

                    // Clear existing data (optional but recommended for a clean restore)
                    await clearObjectStore('dailyLogs');
                    await clearObjectStore('goals');
                    await clearObjectStore('duas');
                    await clearObjectStore('reflections');

                    const transaction = db.transaction(['dailyLogs', 'goals', 'duas', 'reflections'], 'readwrite');
                    const dailyLogsStore = transaction.objectStore('dailyLogs');
                    const goalsStore = transaction.objectStore('goals');
                    const duasStore = transaction.objectStore('duas');
                    const reflectionsStore = transaction.objectStore('reflections');

                    // Add data from backup
                    if (backupData.dailyLogs) {
                        for (const log of backupData.dailyLogs) {
                            await dailyLogsStore.put(log); // Use put to handle potential existing keys
                        }
                    }
                    if (backupData.goals) {
                         // Need to add goals without their old IDs if autoIncrement is used
                         for (const goal of backupData.goals) {
                             const { id, ...goalWithoutId } = goal; // Remove old ID
                             await goalsStore.add(goalWithoutId);
                         }
                    }
                    if (backupData.duas) {
                         // Need to add duas without their old IDs if autoIncrement is used
                         for (const dua of backupData.duas) {
                             const { id, ...duaWithoutId } = dua; // Remove old ID
                             await duasStore.add(duaWithoutId);
                         }
                    }
                     if (backupData.reflections) {
                         // Only expect one reflection, use put
                         if (backupData.reflections.length > 0) {
                             await reflectionsStore.put({ id: 1, ...backupData.reflections[0] });
                         }
                     }


                    transaction.oncomplete = function() {
                        console.log('Data restored successfully');
                        statusElement.textContent = 'Data restored successfully. Please refresh the page.';
                        // Reload data after successful restore
                        loadDailyLogs();
                        loadGoals();
                        loadDuas();
                        loadPostRamadanReflection();
                        updateProgressVisualization();
                    };

                    transaction.onerror = function(event) {
                        console.error('Error during restore transaction:', event.target.error);
                        statusElement.textContent = 'Error during data restore.';
                    };

                } catch (error) {
                    console.error('Error parsing or restoring data:', error);
                    statusElement.textContent = 'Error processing backup file.';
                }
            };
            reader.onerror = function(e) {
                console.error('Error reading file:', e);
                statusElement.textContent = 'Error reading backup file.';
            };
            reader.readAsText(file);
        }

        function clearObjectStore(storeName) {
             return new Promise((resolve, reject) => {
                 const transaction = db.transaction([storeName], 'readwrite');
                 const store = transaction.objectStore(storeName);
                 const request = store.clear();

                 request.onsuccess = () => resolve();
                 request.onerror = (e) => reject(e);
             });
        }


        // Event listener for file input
        document.getElementById('restoreFile').addEventListener('change', restoreData);


        // Initialize the database when the page loads
        openDatabase().catch(error => {
            console.error('Failed to open database:', error);
            alert('Failed to initialize the database. The app may not work correctly.');
        });

        // Basic My Prayer Times App Data Integration Concept (Placeholder)
        // If My Prayer Times app exposes data via a shared schema (e.g., a specific IndexedDB key
        // or a simple API endpoint if running locally), you could attempt to read it here.
        // This is highly speculative and depends entirely on the other app's design.
        async function attemptLoadPrayerTimes() {
             // This is a conceptual placeholder.
             // In a real scenario, you'd need a defined way to access data
             // from the "My Prayer Times" app, likely involving:
             // 1. A shared IndexedDB database name and object store name.
             // 2. A specific key or query to get today's prayer times.
             // 3. Handling potential errors if the other app isn't installed or running.

             // Example (highly hypothetical):
             /*
             const PRAYER_TIMES_DB_NAME = 'myPrayerTimesDB'; // Hypothetical DB name
             const PRAYER_TIMES_STORE_NAME = 'dailyTimes'; // Hypothetical store name
             const todayKey = todayString; // Assuming date is the key

             try {
                 const prayerTimesDBRequest = indexedDB.open(PRAYER_TIMES_DB_NAME, 1); // Assuming version 1

                 prayerTimesDBRequest.onsuccess = function(event) {
                     const prayerTimesDB = event.target.result;
                     const transaction = prayerTimesDB.transaction([PRAYER_TIMES_STORE_NAME], 'readonly');
                     const store = transaction.objectStore(PRAYER_TIMES_STORE_NAME);
                     const request = store.get(todayKey);

                     request.onsuccess = function(event) {
                         const prayerTimes = event.target.result;
                         if (prayerTimes) {
                             // Assuming prayerTimes object has suhoor and iftar properties
                             if (prayerTimes.suhoor) {
                                 document.getElementById('suhoorTime').value = prayerTimes.suhoor;
                             }
                             if (prayerTimes.iftar) {
                                 document.getElementById('iftarTime').value = prayerTimes.iftar;
                             }
                             console.log("Loaded prayer times from external app.");
                         }
                     };

                     request.onerror = function(event) {
                         console.warn("Could not load prayer times for today from external app:", event.target.error);
                     };
                 };

                 prayerTimesDBRequest.onerror = function(event) {
                     console.warn("Could not open external prayer times database:", event.target.errorCode);
                 };
             } catch (error) {
                 console.warn("Error attempting to access external prayer times DB:", error);
             }
             */
             console.log("Attempting to load prayer times (conceptual)...");
             // You would implement the actual logic here if a shared schema exists.
        }

        // Basic My Quran Journey Concept Integration (Placeholder)
        // Similar to prayer times, this depends on a shared schema.
        async function attemptLoadQuranProgress() {
             // This is a conceptual placeholder.
             // You'd need a defined way to access data from the "My Quran Journey" app.

             // Example (highly hypothetical):
             /*
             const QURAN_DB_NAME = 'myQuranJourneyDB'; // Hypothetical DB name
             const QURAN_STORE_NAME = 'readingProgress'; // Hypothetical store name
             const todayKey = todayString; // Assuming date is the key

             try {
                 const quranDBRequest = indexedDB.open(QURAN_DB_NAME, 1); // Assuming version 1

                 quranDBRequest.onsuccess = function(event) {
                     const quranDB = event.target.result;
                     const transaction = quranDB.transaction([QURAN_STORE_NAME], 'readonly');
                     const store = transaction.objectStore(QURAN_STORE_NAME);
                     const request = store.get(todayKey);

                     request.onsuccess = function(event) {
                         const progress = event.target.result;
                         if (progress && progress.juz && progress.page) {
                             document.getElementById('quranProgress').value = `Juz ${progress.juz}, Page ${progress.page}`;
                             console.log("Loaded Quran progress from external app.");
                         } else if (progress && progress.description) {
                              document.getElementById('quranProgress').value = progress.description;
                              console.log("Loaded Quran progress description from external app.");
                         }
                     };

                     request.onerror = function(event) {
                         console.warn("Could not load Quran progress for today from external app:", event.target.error);
                     };
                 };

                 quranDBRequest.onerror = function(event) {
                     console.warn("Could not open external Quran database:", event.target.errorCode);
                 };
             } catch (error) {
                 console.warn("Error attempting to access external Quran DB:", error);
             }
             */
             console.log("Attempting to load Quran progress (conceptual)...");
             // You would implement the actual logic here if a shared schema exists.
        }

        // Call the conceptual integration functions on load
        attemptLoadPrayerTimes();
        attemptLoadQuranProgress();

    </script>
</body>
</html>